#1. 適用範囲
##1.1. 本設計書の対象
本設計書はHUEサービスおよびHUEに付随する関連サービス（以降、HUEサービスと記載）のネットワーク設計について記載する位置づけのものである。

##1.2. 構成概要と適用範囲
HUEサービスの全体イメージを以下に記載する。

図を載せる

本設計書は赤い線で囲った部分についてを取り扱うものとする。

#2. 物理設計
本章ではHUEサービスの物理構成の方針を記載する。

##2.1. 物理設計方針
HUEサービスを提供するためのサーバはAWSが提供するリソースを利用するものとし、物理的なサーバやネットワーク機器は所持しない。基本的にAWSが提供するサーバリソースはワークスアプリケーションズの管理外であるため、物理設計は考慮せず、AWSの規定に従うものとする。

##2.2. 接続設計
AWSを利用するため、物理接続は考慮しない。

##2.3. ファシリティ設計
AWSを利用するため、物理的な制約事項(ラック、電源など)は考慮しない。

#3. 論理設計
本章ではHUEサービスの論理構成の方針を記載する。

##3.1. 論理設計方針
アカウントを分割し、相互の環境で通信を行わない。

| 環境名 | 用途 |
| --- | --- |
| 商用環境 | 顧客テナントを収容する環境 |
| 社内利用環境 |  |
| Apple Review 環境 |  |


##3.2. IPアドレス設計

| セグメント名 | アドレス | 用途 |
| --- | --- | --- |
| [tenant名]-private | 10.x.0.0/18 | 外部からアクセスのないサーバを配置 |
| [tenant名]-public | 10.x.64.0/21 | 外部からのアクセスがあるサーバを配置 |
| [tenant名]-internalprivate | 10.x.96.0/19 | APサーバを配置 |
| HMS管理 | 10.200.0.0/23 | HMS管理用のサーバを配置 |
|  |  |  |

##3.3. VLAN設計
AWSのネットワーク内はオーバーレイ方式のため、VLANは使用しない。

##3.4. ルーティング設計
ルーティング設定はAmazon VPCの機能としてセグメントごとに設定する。
ルーティング設定の
各インスタンスのOSに対して個別にルーティングを設定しない。

##3.5. アドレス変換設計
インターネットからのアクセスがあるインスタンスについては、Amazon EIPを使用し、グローバルIPアドレスを割り当てる。Amazon EIPによってグローバルIPアドレスを割り当てられたインスタンスは、そのアドレスを利用してインターネットへアクセスできる。
インターネットからはアクセスの予定がなく、インターネットへアクセスする必要があるインスタンスについては、AWS NATゲートウェイを利用して、インターネットへのアクセス方向のみ、送信元アドレスをグローバルIPアドレスに変換して、通信を行う。
インターネットと直接通信を行う必要のないインスタンスについては、グローバルIPアドレスの割り当てを行わない。
各インスタンスとグローバルアドレスの割り当てについて、以下に記載する。

表を追加

#4. セキュリティ設計
本章ではHUEサービスのセキュリティ設計について記載する。

##4.1. セキュリティ設計方針
経路のセキュリティ対応。ユーザのアクセスはAmazon ELBサービスを経由してアクセスする。ELBサービスにセキュリティグループを適用し、必要なポート以外へのアクセスを遮断する。
ホストのセキュリティ対策。各インスタンスはセキュリティ対策ソフトウェアを導入し、ウィルスチェックおよび侵入検知を行う。

##4.2. セキュリティ設計
###4.2.1. 通信要件の整理
###4.2.2. オブジェクト設計
###4.2.3. セキュリティゾーン設計
物理的な制約からの分割単位としては以下の区分がある。
・AWS
・ワークスアプリケーションズ HMS
・セキュリティルーム
・ユーザ

AWSでは以下のカテゴリで管理分割する。
・Apple Review環境
・社内利用環境
・商用環境

それぞれの環境内で以下のカテゴリで論理分割する。論理分割はVPC単位で行う。VPC間は指定をしない限り相互に通信を行うことはできない。VPC間の通信については後述する。

###4.2.4. セキュリティポリシー設計



##4.3. 負荷分散設計方針
Amazon ELBを使用し、APサーバの負荷分散を行う。
負荷分散を行う対象は以下の通り。
・HUE
HUEはフロントサーバに対してAmazon ELBを使用してインスタンスへの負荷分散を行う。各インスタンスはkubarnetes内にあるvirtual load balanserにより、適切なプロセスが動作しているコンテナに転送される。
・conversion
Conversion環境はAPサーバに対してAmazon ELBを使用してインスタンスへの負荷分散を行う。

Amazon ELBでは負荷分散先のインスタンスを複数のAvailability zoneから選択するのを基本とする。
また、auto-scaling機能を使用し、負荷分散対象のインスタンスのリソースが不足したと判断された場合に、自動的にインスタンスを追加することで適切なリソースを確保する設計とする。

###4.3.1. 負荷分散設計

###4.3.2. 負荷分散要件の整理


###4.3.3. ヘルスチェック設計
サービスごとのヘルスチェック方式を以下に記載する。

###4.3.4. 負荷分散方式設計
ラウンドロビン方式とする。

###4.3.5. パーシステンス設計
(要確認)セッション情報はcookieで管理し、同一サーバに振り分けられる必要のない作りとなっているため、sticky機能は使用しない。

###4.3.6. SSLアクセラレーション設計
HUEについては、APサーバ内のWebサーバ(nginx)にてSSLを終端する。
後々はAmazon ELBでのSSL通信終端を行う予定。
conversionについては、Amazon ELBでSSLを終端する。

#5. 高可用性設計
本章では高可用性の設計について記載する。

##5.1. 高可用性設計方針
AWSが提供する各サービスにはSLA(サービスレベルアグリーメント)が規定されており、一定の稼働率については保証されるが、AWSの各サービスでは事前のアナウンスなくメンテナンスが行われることもあり、一部のサービスがダウンしてもHUEサービスを継続できるよう設計を行う必要がある。
AWSでは以下のポイントがある。
・EC2インスタンス単位での負荷分散による高可用性
・availability zoneでの負荷分散による高可用性

##5.2. AWS稼働率
HUEサービスが利用しているサービスと、AWSが公称している各サービスの稼働率を以下に記載する。

| サービス名 | 稼働率 |
| --- | --- |
| Amazon EC2 | 99.95％ |
| Amazon S3 | 99.9％ |
| Amazon Route 53 | 100％ |
| Amazon VPC | なし |

##5.3. リンク冗長設計
AWSを利用しているため、物理リンクの冗長については考慮しない。

##5.4. 筐体冗長設計
Amazon AWSを利用しているため、物理サーバの障害については考慮しない。
インスタンスの障害に関して追記する。

##5.5. ファイアウォール冗長化設計
ファイアウォールは使用しない。

##5.6. 負荷分散装置冗長化設計
Amazon ELBはデフォルトで2つ以上のグローバルIPで冗長化されている。
サービスユーザはFQDNを利用したアクセスを行う。ドメイン名はAmazon Route 53によりアドレスに解決されるが、サービス提供が可能なグローバルIPアドレスのみをAレコードとして応答することで、サービス提供不可の状態を回避する。

##5.7. 通信フローの整理

###5.7.1. 通常時フロー

###5.7.2. 障害時フロー

#6. 管理設計
本章では管理設計に関する方針を記載する。

##6.1. 管理設計方針
HUEシステムの各インスタンスに管理アクセスできるのはワークスアプリケーションズ社内のHUE Management Service 部門、およびワークスアプリケーションズ内に設置されたセキュアルームからのみとする。
AWS内のインスタンスへ管理目的でアクセスする場合、専用に作成したインスタンス（WorkTerminalと呼ぶ）を経由して接続する。
WorkTerminalはUbuntuとWindowsの2種類作成し、UbuntuへはSSH、Windowsへはリモートデスクトップを利用して接続する。

##6.2. ホスト名設計
ホスト名はIPアドレスに基づき自動的にAWSで作成されるホスト名をそのまま使用する。

##6.3. パスワード設計
管理者からWorkTerminalへのSSHへの接続、またはWorkTerminalから各インスタンスへのSSH接続は認証に証明書を使用するものとし、パスワードは使用しない。
Windowsへの接続は指定のパスワードを使用する。

##6.4. バックアップ・リストア設計
バックアップ方針を記載する。
・作業前後でバックアップを取得する
・各インスタンスについて定期バックアップの間隔を設定する

##6.5. 時刻同期設計
各インスタンスはNTPサーバで時刻を同期する。環境ごとに代表NTPサーバを用意する。各インスタンスは代表NTPサーバに時刻同期をする。代表NTPサーバはxxxxと時刻同期をする。

##6.6. その他方針
リモートルームでの作業については別途利用手引きを参照する。
作業は必ずログを取得する（変更管理）


#7. 監視設計
本章では監視設定について方針を記載する。
監視項目の詳細については、別紙：監視設計書に記載する。

##7.1. 監視の概要
HUEネットワークでは各インスタンスにZabbixエージェントをインストールし、ZABBIXによる集中監視を行う。
すべてのインスタンスに対して行う定型監視のほか、インスタンスの役割により、適切な監視項目を適用する。

すべてのインスタンスに実施する監視
・リソース監視(メモリ、CPU、ディスク)
・ネットワーク到達(ICMP、ZABBIXエージェントとの通信到達性)

インスタンスにより実施する監視
・定期ポーリングによるサービス監視
・プロセス起動監視

##SNMP設計
ZABBICエージェントによる死活監視を行うため、SNMPによる監視設定は行わない。

##Syslog設計
インスタンスはfluentdを使用してログ収集し、kibanaサーバへ集約する。
ログ送信はリアルタイムで行われる。
ログはkibanaサーバ上ではxx日間以上保管し、必要に応じて確認できるするものとする。その後、Amazon S3サービスで最低xx日間保存する。
